---
layout: post
title: Malware Analysis Lab - Part 2 - The Router Firewall
subtitle: The Router Firewall
tags: [lab, malware, firewall, raspberry pi]
---

# Introduction

In post [Malware Analysis Lab - Part 1 - The Gateway]({% post_url 2021-02-08-Malware-Lab-Part-1-The-Gateway %}), I've described the steps taken to create a "Gateway" virtual machine. Please note that <span class="highlight-red"> the instructions included in this post require a Raspberry Pi computer board.</span>

This post is an addition and aims to expand on the previously created analysis environment by using a Raspberri Pi computer board to add Router, Firewall and OpenVPN client capability to the analysis environment.

## Logical architecture

The following image identifies the logical architecture of the lab environment with the changes at the top of the image in blue, these affect the "Physical" layer of the diagram. Everything else remains unchanged:

![](../assets/lab-part-2/Malware_Analysis_Lab_Raspberry_Pi.png)

# Hardware

A working Raspberry Pi computer board with an SD Card is required. For more information about the different versions of the Raspberry Pi supported by IPFire please see this link: [https://wiki.ipfire.org/hardware/arm/rpi](https://wiki.ipfire.org/hardware/arm/rpi)

# Software

IPFire is going to be used to create a Router, Firewall and OpenVPN client on a Raspberry Pi computer.

> "IPFire is a hardened, versatile, state-of-the-art Open Source firewall based on Linux. Its ease of use, high performance in any scenario and extensibility make it usable for everyone." [IPFire website](https://www.ipfire.org/)

Download an IPFire image according to the Raspberry Pi model of your choosing from [https://www.ipfire.org/](https://www.ipfire.org).

# Flashing IPFire image

After finishing downloading the OS image to a computer, flash the downloaded image to the Raspberry Pi's SD Card. [IPFire website](https://wiki.ipfire.org/hardware/arm/rpi/three) provides easy to follow instructions for various Operating Systems. 

In a nutshell, the process can be done with just a few terminal commands (for reference, I'm using a Linux Ubuntu 20.04 machine):

1. <pre><code class="bash">lsblk</code></pre> shows the devices currently mounted and can be used to identify the SD Card,
2. <pre><code class="bash">umount /dev/sd<span class="highlight-green">X</span></code></pre> unmount the "sdX" (SD Card) drive partitions,
3. <pre><code class="bash">xzcat <span class="highlight-green">/path/to</span>/<span class="highlight-green">IPFIRE_IMAGE</span>.img.xz | sudo dd bs=1M of=/dev/sd<span class="highlight-green">X</span></code></pre> writes the "IPFIRE_IMAGE" image located in the absolute path "/path/to" to device "X",

4. According to IPFire website's instructions as I use HDMI output and I have a small USB Keyboard, I had to edit the "uENV.txt" file and change "SERIAL-CONSOLE" from "ON" to "OFF".

5. <pre><code class="bash">eject /dev/sd<span class="highlight-green">X</span></code></pre> unmounts and ejects the "sdX" drive from the computer. The SD Card can then be removed and plugged into the Raspberry Pi.

# OS Configuration

Plug the SD Card in the Raspberry Pi and start it up. Wait a couple of minutes for the OS to boot. 

Once booted IPFire comes with a handy setup tool to guide you through the initial configuration process. Unfortunately I didn't take pictures of the configuration screens when I was configuring the system. Nevertheless, the following images were taken after the configuration using a SSH remote connection to capture the configuration details, for completeness sake.

The first screen allows to choose the "Keyboard" map to use, the next screen selects the "Timezone", followed by "Hostname" and "Domain name" setup screens. 

The installation process then goes through setting the root user password for access to the Raspberry Pi box, followed by the admin user password, required when accessing through the web interface.

In the "Network configuration menu" select "Network configuration type" and make sure to use "GREEN + RED". Although IPFire provides a "GREEN + RED + BLUE" option with Blue intended for Wireless networks, the Raspberry Pi by default only has 2 network cards, hence we can only create 2 interfaces.

![](../assets/lab-part-2/gateway-raspberrypy-network-conf-menu.png)

"Drivers and card assignments" menu is where the mapping of the Raspberry Pi's network cards to interfaces is done. Map the Wireless card "sdio: brcmfmac" to GREEN interface, and the remaining card "usb: SMSC9512/9514" should map to RED interface. For more information on these, please visit [https://wiki.ipfire.org/installation/step5](https://wiki.ipfire.org/installation/step5).

![](../assets/lab-part-2/gateway-raspberrypy-drivers-card-ass.png)

The "Address settings" menu is for configuration of the mapped interfaces. Note that when configuring the "GREEN" interface a warning message will display, this is normal. I've used "IP address" 192.168.2.10, and "Network mask" 255.255.255.0.

![](../assets/lab-part-2/gateway-raspberrypy-interface-green.png)

For the RED interface, I enabled DHCP and left all values as per default.

![](../assets/lab-part-2/gateway-raspberrypy-interface-red.png)

Click "Ok" and then "Done" until the "DHCP server configuration" screen appears. In this screen assign IP values to "Start Address" 192.168.2.11, "End Address" 192.168.2.20 and "Primary DNS" use your ISP modem IP address, "Secondary DNS" 192.168.2.1, and click "Ok". Note the range 11 to 20 allows up to 19 hosts to be added on the network, if you require more hosts to connect then increase the values.

The message "Setup is complete" is displayed when the process is complete. 

# Enabling Wireless Access

Wireless access is disabled by default, to enable the access point login with the root account and install "hostapd" application using the following command:

<pre><code class="bash">pakfire install hostapd</code></pre> 

The hostapd.conf file by default uses the BLUE interface. As we didn't create a BLUE interface we need to change it to use the GREEN one instead:

<pre><code class="bash">sed -i 's/interface=blue0/interface=green0/g' /etc/hostapd.conf</code></pre> 

The same applies to /etc/init.d/hostapd file, change the default interface from BLUE to GREEN:

<pre><code class="bash">sed -i 's/INTERFACE="blue0"/INTERFACE="green0"/g' /etc/init.d/hostapd</code></pre> 

A default password is set in /etc/hostapd.conf file. Change "MY_PASSWORD" to your prefered password for WiFi access to the network:

<pre><code class="bash">sed -i 's/wpa_passphrase=IPFire-2.x/wpa_passphrase=<span class="highlight-green">MY_PASSWORD</span>/g' /etc/hostapd.conf</code></pre> 

Once done, reboot the system for the settings to take effect:

<pre><code class="bash">reboot</code></pre>

# IPFire Web interface

After the system finishes booting, connect to the Wifi network. The web interface can be accessed through the URL [https://192.168.1.1:444](https://192.168.1.1:444). Use your admin user details to login.

## SSH Access

SSH configuration can be accessed through the top bar navigation menu, by going to "System" -> "SSH Access":

![](../assets/lab-part-2/gateway-raspberrypy-webinterface-ssh.png)

Make sure that "SSH Access" and "Set SSH port to default 22 (222) is used otherwise" options are unticked. Instead of having SSH always enabled it's best to allow temporary connections instead. 

SSH sessions lasting for as long as 15 minutes can be created by using the "Stop SSH demon in 15 minutes" button. Once a session is allowed you can then ssh to the remote box:

<pre><code class="bash">ssh root@192.168.1.1 -p 222</code></pre>

## OpenVPN Server list (NordVPN)

It's now time to ssh to the remote box and download the list of servers from your VPN provider. First save your VPN authentification details in a file for automated authentification. Replace "<span class="highlight-green">USER_NAME</span>" and "<span class="highlight-green">USER_PASSWORD</span>" with your VPN account details and execute in the SSH session:

<pre><code class="bash">mkdir -p /etc/openvpn && printf "USER_NAME\nUSER_PASSWORD\n" > /etc/openvpn/auth.conf && sudo chmod 600 /etc/openvpn/auth.conf
</code></pre>

Download your VPN provider "ovpn" configuration files. In the next example I use NordVPN service, other providers should be similar but with a different download link:

<pre><code class="bash">mkdir -p /etc/openvpn/ovpn && wget https://downloads.nordcdn.com/configs/archives/servers/ovpn.zip -P /etc/openvpn && unzip /etc/openvpn/ovpn.zip -d /etc/openvpn/ovpn && rm /etc/openvpn/ovpn.zip</code></pre>

Keep in mind that from time to time an updated list of servers should be downloaded for the most up-to-date ovpn configuration files.

Symlink your desired location and server, replacing "YOUR_OVPN_SERVER" with your VPN server selection to establish a connection to during the VPN session:

<pre><code class="bash">ln -sf /etc/openvpn/ovpn/<span class="highlight-green">YOUR_VPN_SERVER</span> /etc/openvpn/vpn.ovpn</code></pre>

Whenever necessary to change servers, enable SSH sessions, login and re-create the symlink to point to a new ovpn file. 

## Firewall rule

Add the following IP Tables rule to /etc/sysconfig/firewall.local file, just below the line "##add your 'start' rules here". This rule will route all traffic from the 192.168.0.0/16 network through the VPN tunnel.

<pre><code class="bash">iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -o tun0 -j MASQUERADE</code></pre>

## DNS

To prevent DNS leaks ISP DNS should be disabled and you should instead use the VPN service provider or Google DNS server adresses. You can test your VPN connection for DNS leaks using [https://www.dnsleaktest.com/](https://www.dnsleaktest.com/). In IPFire's web interface, navigate to "Network" -> "Domain Name System" and untick the "Use ISP-assigned DNS Servers" option. Then add which DNS servers IPs you want to use by clocking the "Add" button and filling the details making sure each entry is ticked in the list.

![](../assets/lab-part-2/gateway-raspberrypy-webinterface-dns.png)

For reference, a list of public DNS servers is available in [IPFire website](https://wiki.ipfire.org/dns/public-servers).

## Starting OpenVPN

Create the following script to start a VPN session using the previously selected details:

<pre><code class="bash">cat <<-'EOF' > "/$HOME/start-vpn.sh"
#! /bin/bash

mkdir -p /dev/net
mknod /dev/net/tun c 10 200
chmod 600 /dev/net/tun
openvpn --config /etc/openvpn/vpn.ovpn --auth-user-pass /etc/openvpn/auth.conf --auth-nocache
EOF
chmod +x /$HOME/start-vpn.sh
</code></pre>

Execute the script ```start-vpn.sh``` and if everything is right you should see the message "Initialization Sequence Completed".