---
layout: post
title: Malware Analysis Lab - Part I
subtitle: A Logical View of The Lab
tags: [lab, malware]
---

This is the first part of a series of three articles dealing with how you can build a Malware Analysis environment where you can execute, analyse and collect indicators of compromise from malware in a contained environment. 

Part I (this article), shows the logical structured that is going to be implemented in the Lab, this article provides a visual representation of the guest VMs and the network along with the rationale for the choices made.

Part II (available [here]({% link _posts/2021-02-08-Malware-Lab-Part-II.md %})) details the steps ncessary to create and setup up a Linux Virtual Machine that will act as a network Gateway. This VM will simulate network services used by the Analysis Virtual Machine. The VM will also have various Static analysis tools and Network monitoring tools installed.

Part III will include the steps taken to setup a Windows Analysis machine, how the network can be configured and how to enable file transfer between the Gateway and the Analysis machine in a safe way. This article highlights various actions that can be taken to to harden the VM preventing Malware from detecting that it's running in a virtualized environment. This machine will have installed a network monitoring tool, a debugger, a dissassembler and a few other support tools.

Whenever possible, scripts for automation of the process will be included in the articles.

# Architecture

![](../assets/lab-part-1/Malware_Analysis_Lab.png)

# Network

The objective is to build a lab with two Guest virtual machines and an Internal network isolated from the Internet. The lab uses an Internal Network type to provide network connectivity to both virtual machines in the lab. A software proxy tool is to be installed to allow the decryption of TLS encrypted traffic from malware using generated signed certificates to enable to decript network traffic communications. The lab should satisfy the following basic requirements:
- The Gateway machine should be able to receive files from the Host machine and be capable of communicating through an internal network with the Analysis Machine. 
- The Gateway machine should be capable of acessing the Internet when required, likewise the Gateway machine should be capable of disabling any acess to the Internet.
- The Analysis Machine should be able of receiving files from the Gateway Machine but shoudn't be allowed to communicate with the Host machine or the Internet. 
- Both VMs should be able to have network connectivity between themselves.

Each VM will have a fixed IP address. Network traffic will be redirected from the Windows machine to the Linux machine. Specific software will be used to create a simulated network environment. The lab will have network firewall rules enabled when simulating the network to manage network traffic access and manage traffic redirection.

Assessment of the network communication between machines will be tested and the network traffic will be validated  between the Gateway and the Analysis machine.

# Gateway Machine

| Name | Name | Rationale |
| --- | --- | --- |
| Name | Gateway | To be able to uniquely identify the machine |
| Operating System | Linux (Ubuntu 20.04.2 Server LTS) | A different Operating System from the infected Target virtual machine using ELF (Executable and Linkable Format) executables which prevents the execution of the malware binaries |
| Architecture | 64 Bits | A modern architecture |
| Number of CPUs | 4 virtual CPUs | To help prevent detection of the virtualized environment by the malware |
| Disk space allocated | 100 GB | To install all necessary software |
| RAM | 4096 Mb | For performance reasons |
| Network Adapter #1 | NAT (Network Address Translation) - IP Address: 10.0.2.15 | To be able to access the Internet to download software, updates or any other necessary files |
| Network Adapter #2 | Internal Network - Name: malwarenet - Promiscuous Mode: Allow All - IP Address: 192.168.111.2 | To provide simulated network connectivity to the VM, Promiscuous mode was set to Allow All in order to allow the network adapter to be able to see all traffic and run properly all network tools |
| Network Gateway | 192.168.100.1 (Internal Network LAN) 10.0.2.2 (NAT WAN) | (N/A) Default values |
| USB | USB Controller disabled | To prevent the hypervisor from automatically mounting any USB device in the guest when connected to the host |
| Shared Folders | Enabled | Not mounted by default, necessary to be able to transfer files with the host machine when needed |
| Guest Additions | Installed | To increase performance and add extra functionality |

For the full article on how to setup the Gateway VM, please see [Part II - The Gateway Machine]({% link _posts/2021-02-08-Malware-Lab-Part-II.md %}).

# Analysis Machine

| Name | Name | Rationale |
| --- | --- | --- |
| Name | WIN7-32 | To be able to uniquely identify the machine |
| Operating System | Microsoft Windows 7 SP 1 | Currently the most targeted OS by malware |
| Architecture | 64 Bits | Capable of running both 32 and 64 Bits binaries |
| Number of CPUs | 4 virtual CPUs | To help prevent detection of  the virtualized environment by the malware |
| Disk space allocated | 120 GB | To install all necessary software and help prevent VM detection |
| RAM | 4096 Mb | For performance and help prevent the detection of the virtualized environment by the malware |
| Network Adapter | Internal Network - Name: malnet - Promiscuous Mode: Allow VMs -	IP Address: 192.168.111.3 | To provide network connectivity to the VM in case the malware requires network access, Promiscuous mode was set to Allow VMs in order to prevent the host from sending data to the guest but allowing proper communication between VMs on the internal network, the Mac address will be modified to be different from a VirtualBox Mac address to prevent identification of the VM environment |
| Network Gateway & DNS Server | 192.168.111.2 (Internal Network LAN) | To direct all network traffic into the Gateway virtual machine |
| USB | USB Controller disabled | To prevent the hypervisor from automatically mounting and giving access to the guest virtual machine to any USB device connected to the host |
| Shared Folders | Disabled | To prevent the hypervisor from automatically mounting and giving access to the guest virtual machine to any USB device connected to the host |
| Guest Additions | Not Installed | To help prevent detection of  the virtualized environment by Malware |